<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardiol-IA - Recomendación de Alineación</title>

    <!-- Favicon -->
    <link th:replace="~{menu :: faviconFragment}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Estilos del menú -->
    <style th:replace="~{menu :: menuStyles}"></style>

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            display: flex;
            min-height: 100vh;
        }

        .chat-container {
            margin-left: 230px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .chat-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 900px;
            width: 100%;
            padding: 2rem;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .assistant-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .assistant-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #667eea;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .assistant-info h2 {
            margin: 0;
            color: #667eea;
            font-weight: bold;
        }

        .assistant-info p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            position: relative;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .message-bubble::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 30px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #667eea;
        }

        .recommendation-content {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            white-space: pre-wrap;
            font-family: 'Inter', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .btn-custom {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-regenerate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }

        .btn-regenerate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-back {
            background: #6c757d;
            border: none;
            color: white;
        }

        .btn-back:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Pantalla de carga */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-logo {
            width: 150px;
            height: 150px;
            margin: 0 auto 2rem;
            animation: spin 2s linear infinite;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-subtext {
            font-size: 1.4rem;
            font-weight: 500;
            opacity: 0.95;
            transition: opacity 0.4s ease;
        }

        /* Alertas personalizadas */
        .alert-custom {
            border-radius: 10px;
            border: none;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-custom i {
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-container {
                margin-left: 0;
            }

            .chat-box {
                padding: 1rem;
            }

            .assistant-header {
                flex-direction: column;
                text-align: center;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-custom {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de carga (visible por defecto) -->
    <div class="loading-overlay" id="loadingOverlay" style="display: flex;">
        <div class="loading-content">
            <img th:src="@{/logoliga.png}" alt="Logo Liga" class="loading-logo">
            <div class="loading-text">Generando recomendación...</div>
            <div class="loading-subtext" id="loadingMessage">Guardiol-IA está analizando los mejores jugadores para ti</div>
        </div>
    </div>

    <!-- Incluir menú lateral -->
    <div class="main-container">
        <div th:replace="~{menu :: menuLateral}"></div>

        <!-- Contenedor del chat (oculto inicialmente) -->
        <div class="chat-container" id="chatContainer" style="opacity: 0; transition: opacity 0.5s ease;">
            <div class="chat-box">
                <!-- Header del asistente -->
                <div class="assistant-header">
                    <img th:src="@{/guardiola.jpg}"
                         alt="Guardiol-IA"
                         class="assistant-avatar"
                         >
                    <div class="assistant-info">
                        <h2>Guardiol-IA</h2>
                        <p>Tu asistente experto en Fantasy Fútbol Sala</p>
                    </div>
                </div>

                <!-- Mensaje de saludo -->
                <div class="message-bubble">
                    <i class="fas fa-robot me-2"></i>
                    <strong>Guardiol-IA dice:</strong>
                    <p class="mt-2 mb-0">
                        ¡Hola <span th:text="${nombreUsuario}">Manager</span>!
                        Esta es mi recomendación de alineación para esta jornada.
                    </p>
                </div>

                <!-- Contenido de la recomendación (se llenará dinámicamente) -->
                <div class="recommendation-content" id="recomendacionContent" style="display: none;">
                    <!-- El contenido se cargará aquí mediante AJAX -->
                </div>

                <!-- Mensaje de error (se mostrará si hay error) -->
                <div id="errorContainer" class="alert alert-danger alert-custom" role="alert" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div style="display: inline-block;">
                        <strong>Error al generar recomendación</strong>
                        <p id="errorMessage" style="margin: 0.5rem 0 0 0;"></p>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="action-buttons">
                    <a href="#" id="btnRegenerar"
                       class="btn btn-regenerate btn-custom"
                       onclick="regenerarRecomendacion(); return false;">
                        <i class="fas fa-sync-alt me-2"></i>
                        Generar Nueva Recomendación
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        // Variables del modelo Thymeleaf
        const ligaId = /*[[${ligaId}]]*/ 0;
        const usuarioId = /*[[${usuarioId}]]*/ 0;

        // Mensajes divertidos para la pantalla de carga
        const mensajesCarga = [
            "Llamando a Fabricio Romano...",
            "Activando palancas...",
            "Pidiendo informes a Negreira...",
            "Subiendo el sueldo del Cholo...",
            "Recalificando los terrenos del Bernabéu...",
            "Escuchando audios de Florentino...",
            "Ayudando a Lamine Yamal con los deberes de Mates...",
            "Inscribiendo a Dani Olmo en LaLiga (otra vez)...",
            "Pidiéndole a Mbappé que baje a defender...",
            "Buscando dónde se ha escondido Julián Álvarez...",
            "Viendo la King's League porque no entiendo las manos dentro del área...",
            "Comprando los billetes de avión para que Araujo se vaya a Israel...",
        ];

        let intervaloCambioMensaje = null;

        /**
         * Función para cambiar mensajes de carga aleatoriamente
         */
        function iniciarCambioMensajes() {
            const elementoMensaje = document.getElementById('loadingMessage');
            let mensajesUsados = [];

            // Cambiar mensaje cada 3 segundos
            intervaloCambioMensaje = setInterval(() => {
                // Si ya usamos todos los mensajes, reiniciar
                if (mensajesUsados.length === mensajesCarga.length) {
                    mensajesUsados = [];
                }

                // Obtener mensajes disponibles (no usados aún)
                const mensajesDisponibles = mensajesCarga.filter(msg => !mensajesUsados.includes(msg));

                // Seleccionar mensaje aleatorio de los disponibles
                const indiceAleatorio = Math.floor(Math.random() * mensajesDisponibles.length);
                const mensajeSeleccionado = mensajesDisponibles[indiceAleatorio];

                // Marcar como usado
                mensajesUsados.push(mensajeSeleccionado);

                // Cambiar el mensaje con efecto fade más suave
                elementoMensaje.style.opacity = '0';
                setTimeout(() => {
                    elementoMensaje.textContent = mensajeSeleccionado;
                    elementoMensaje.style.opacity = '1';
                }, 400);
            }, 3000);
        }

        /**
         * Función para detener el cambio de mensajes
         */
        function detenerCambioMensajes() {
            if (intervaloCambioMensaje) {
                clearInterval(intervaloCambioMensaje);
                intervaloCambioMensaje = null;
            }
        }

        /**
         * Función para cargar la recomendación mediante AJAX
         */
        function cargarRecomendacion() {
            const url = `/liga/${ligaId}/alineacion-sugeria/generar?usuarioId=${usuarioId}`;

            console.log('Cargando recomendación desde:', url);

            // Mostrar overlay de carga
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('chatContainer').style.opacity = '0';
            document.getElementById('recomendacionContent').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';

            // Iniciar cambio de mensajes aleatorios
            const loadingMessage = document.getElementById('loadingMessage');
            loadingMessage.style.transition = 'opacity 0.4s ease';
            iniciarCambioMensajes();

            // Hacer petición AJAX
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Respuesta recibida:', data);

                    if (data.success) {
                        // Mostrar la recomendación
                        document.getElementById('recomendacionContent').textContent = data.recomendacion;
                        document.getElementById('recomendacionContent').style.display = 'block';
                        document.getElementById('errorContainer').style.display = 'none';
                    } else {
                        // Mostrar error
                        document.getElementById('errorMessage').textContent = data.error;
                        document.getElementById('errorContainer').style.display = 'block';
                        document.getElementById('recomendacionContent').style.display = 'none';
                    }

                    // Detener cambio de mensajes y ocultar overlay con transición suave
                    detenerCambioMensajes();
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('chatContainer').style.opacity = '1';
                    }, 500);
                })
                .catch(error => {
                    console.error('Error en la petición:', error);

                    // Mostrar error
                    document.getElementById('errorMessage').textContent =
                        'Error de conexión. No se pudo contactar con el servidor.';
                    document.getElementById('errorContainer').style.display = 'block';
                    document.getElementById('recomendacionContent').style.display = 'none';

                    // Detener cambio de mensajes y ocultar overlay
                    detenerCambioMensajes();
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('chatContainer').style.opacity = '1';
                    }, 500);
                });
        }

        /**
         * Función para regenerar la recomendación
         */
        function regenerarRecomendacion() {
            cargarRecomendacion();
        }

        /**
         * Cargar la recomendación automáticamente al cargar la página
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página cargada, iniciando petición AJAX...');
            // Esperar un momento para que se vea la animación de carga
            setTimeout(() => {
                cargarRecomendacion();
            }, 500);
        });
    </script>
</body>
</html>

