<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercado y Estadísticas - Liga del Cume</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style th:replace="~{menu :: menuStyles}"></style>

    <style>
        /* (TUS ESTILOS SE MANTIENEN IGUAL, SOLO AÑADO UNO PARA OCULTAR ELEMENTOS) */
        body { margin: 0; padding: 0; background: #0A0E27; color: white; font-family: Arial, sans-serif; min-height: 100vh; }
        .main-content { margin-left: 230px; padding: 2rem; min-height: 100vh; }
        .page-header { margin-bottom: 2rem; text-align: center; }
        .page-title {
            font-size: 64px;
            font-weight: 900;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
            letter-spacing: -2px;
            text-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);
        }

        .search-container { max-width: 800px; margin: 0 auto 2rem auto; position: relative; }
        .search-input { width: 100%; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 50px; padding: 1rem 1.5rem; padding-right: 3.5rem; color: white; font-size: 1.1rem; }
        .search-input:focus { outline: none; background: rgba(255, 255, 255, 0.15); border-color: #FF3366; box-shadow: 0 0 15px rgba(255, 51, 102, 0.3); }

        /* Icono de búsqueda estático */
        .search-icon-box { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #FF3366; font-size: 1.2rem; pointer-events: none; }

        .filters-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 3rem; }

        /* Estilo Botón (ahora <button> en vez de <a>) */
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 0.6rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 1rem;
        }

        .filter-btn:hover, .filter-btn.active {
            background: linear-gradient(135deg, #D946A6 0%, #FF3366 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 5px 15px rgba(255, 51, 102, 0.4);
        }

        /* Clase utilitaria para ocultar elementos con JS */
        .d-none-custom { display: none !important; }

        /* Grid y Cards */
        .jugadores-grid { display: grid; gap: 1.5rem; max-width: 1000px; margin: 0 auto; }
        .jugador-card-row { background: linear-gradient(165deg, rgba(30,30,50,0.9) 0%, rgba(20,20,35,0.95) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1.5rem; transition: all 0.3s ease; position: relative; overflow: hidden; text-decoration: none; }
        .jugador-card-row:hover { transform: translateX(10px); border-color: #FFD700; background: linear-gradient(165deg, rgba(40,40,60,0.95) 0%, rgba(25,25,45,1) 100%); }
        .img-container { position: relative; width: 70px; height: 70px; flex-shrink: 0; }
        .jugador-foto-small { width: 70px; height: 70px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); object-fit: cover; background: #fff; }
        .equipo-badge { position: absolute; bottom: -5px; right: -5px; width: 28px; height: 28px; background: white; border-radius: 50%; border: 2px solid #1a1f3a; padding: 2px; }
        .jugador-details { flex: 1; min-width: 0; }
        .jugador-nombre { font-size: 1.2rem; font-weight: bold; color: white; margin: 0; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .jugador-posicion { color: #aaa; font-size: 0.9rem; margin-top: 0.2rem; }
        .stats-group { display: flex; gap: 2rem; align-items: center; }
        .stat-box { text-align: center; min-width: 70px; }
        .stat-value { font-size: 1.3rem; font-weight: 900; color: white; display: block; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .price-tag { background: rgba(255, 215, 0, 0.1); color: #FFD700; padding: 0.4rem 0.8rem; border-radius: 10px; font-weight: bold; font-size: 0.9rem; border: 1px solid rgba(255, 215, 0, 0.3); white-space: nowrap; }

        @media (max-width: 768px) {
            .main-content { margin-left: 0; padding: 1rem; }
            .jugador-card-row { flex-direction: column; text-align: center; }
            .stats-group { width: 100%; justify-content: space-around; }
        }
    </style>
</head>
<body>

<div th:replace="~{menu :: menuLateral}"></div>

<div class="main-content">

    <div class="page-header">
        <h1 class="page-title">Mercado y Estadísticas</h1>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input"
               placeholder="Buscar jugador por nombre (empieza por...)...">
        <div class="search-icon-box">
            <i class="bi bi-search"></i>
        </div>
    </div>

    <div class="filters-container">

        <button id="btn-jugadores" class="filter-btn active" onclick="cambiarRol('false')">
            <i class="bi bi-people-fill"></i> Jugadores
        </button>

        <button id="btn-porteros" class="filter-btn" onclick="cambiarRol('true')">
            <i class="bi bi-shield-shaded"></i> Porteros
        </button>

        <div style="width: 1px; background: rgba(255,255,255,0.2); margin: 0 10px;"></div>

        <button id="btn-sort-goles" class="filter-btn" onclick="ordenarPor('goles')">
            <i class="bi bi-trophy-fill"></i> Goleadores
        </button>

        <button id="btn-sort-puntos" class="filter-btn" onclick="ordenarPor('puntos')">
            <i class="bi bi-star-fill"></i> Top Puntos
        </button>

        <button id="btn-sort-precio" class="filter-btn" onclick="ordenarPor('precio')">
            <i class="bi bi-currency-euro"></i> Mayor Valor
        </button>
    </div>

    <div class="jugadores-grid" id="lista-jugadores">

        <a th:each="jugador : ${jugadores}"
           th:href="@{/liga/{idLiga}/jugador/{jugadorId}(idLiga=${ligaId}, jugadorId=${jugador.idJugador})}"
           class="jugador-card-row"
           th:data-es-portero="${jugador.esPortero}"
           th:data-nombre="${#strings.toLowerCase(jugador.nombreJugador)}"
           th:data-puntos="${puntosTotalesMap.get(jugador.idJugador) ?: 0}"
           th:data-goles="${golesTotalesMap.get(jugador.idJugador) ?: 0}"
           th:data-precio="${jugador.precioMercado}">

            <div class="img-container">
                <img th:src="${jugador.avatarUrl != null and jugador.avatarUrl != '' ? jugador.avatarUrl : 'https://ui-avatars.com/api/?name=' + #strings.replace(jugador.nombreJugador, ' ', '+') + '&size=128&background=random&bold=true&rounded=true'}"
                     class="jugador-foto-small" alt="Foto">
                <img th:src="${jugador.equipo.escudoURL}" class="equipo-badge" alt="Escudo">
            </div>

            <div class="jugador-details">
                <h3 class="jugador-nombre" th:text="${jugador.nombreJugador}">Nombre</h3>
                <div class="jugador-posicion">
                    <span th:text="${jugador.esPortero ? 'Portero' : 'Jugador de Campo'}">Pos</span> -
                    <span th:text="${jugador.equipo.nombreEquipo}">Equipo</span>
                </div>
            </div>

            <div class="stats-group">
                <div class="stat-box">
                    <span class="stat-value" th:text="${puntosTotalesMap.get(jugador.idJugador) ?: 0}">0</span>
                    <span class="stat-label">Puntos</span>
                </div>

                <div class="stat-box">
                    <span class="stat-value" style="color: #FF3366;">
                        <i class="bi bi-trophy" style="font-size: 0.8em;"></i>
                        <span th:text="${golesTotalesMap.get(jugador.idJugador) ?: 0}">0</span>
                    </span>
                    <span class="stat-label">Goles</span>
                </div>

                <div class="stat-box">
                    <div class="price-tag" th:text="${#numbers.formatDecimal(jugador.precioMercado / 1000000.0, 1, 2) + ' M€'}">
                        10.5 M€
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div id="no-results" style="text-align: center; color: #888; padding: 3rem; display: none;">
        <i class="bi bi-emoji-frown" style="font-size: 3rem;"></i>
        <p class="mt-3">No se encontraron coincidencias.</p>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Estado inicial
    let rolActual = 'false'; // 'false' = jugadores, 'true' = porteros (String porque viene del HTML)
    let criterioOrden = 'precio'; // precio, goles, puntos

    // Referencias al DOM
    const container = document.getElementById('lista-jugadores');
    const searchInput = document.getElementById('searchInput');
    const noResultsMsg = document.getElementById('no-results');

    // Botones
    const btnJugadores = document.getElementById('btn-jugadores');
    const btnPorteros = document.getElementById('btn-porteros');
    const btnSortGoles = document.getElementById('btn-sort-goles');
    const btnSortPuntos = document.getElementById('btn-sort-puntos');
    const btnSortPrecio = document.getElementById('btn-sort-precio');

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
        aplicarFiltros(); // Aplicar filtros iniciales
    });

    // Event Listener Búsqueda
    searchInput.addEventListener('keyup', () => {
        aplicarFiltros();
    });

    // Función 1: Cambiar entre Jugadores y Porteros
    function cambiarRol(nuevoRol) {
        rolActual = nuevoRol;

        // Actualizar estado visual de botones de rol
        if (rolActual === 'false') {
            btnJugadores.classList.add('active');
            btnPorteros.classList.remove('active');
            // Mostrar botón de ordenar por goles
            btnSortGoles.style.display = 'flex';
        } else {
            btnJugadores.classList.remove('active');
            btnPorteros.classList.add('active');
            // Ocultar botón de ordenar por goles (no tiene sentido en porteros normalmente)
            btnSortGoles.style.display = 'none';

            // Si estábamos ordenando por goles y cambiamos a porteros, resetear a precio o puntos
            if (criterioOrden === 'goles') {
                criterioOrden = 'puntos';
                actualizarBotonesOrden();
            }
        }

        aplicarFiltros();
    }

    // Función 2: Establecer criterio de ordenación
    function ordenarPor(criterio) {
        criterioOrden = criterio;
        actualizarBotonesOrden();
        aplicarFiltros(); // Re-ordenar y filtrar
    }

    function actualizarBotonesOrden() {
        // Quitar active de todos
        btnSortGoles.classList.remove('active');
        btnSortPuntos.classList.remove('active');
        btnSortPrecio.classList.remove('active');

        // Poner active al actual
        if (criterioOrden === 'goles') btnSortGoles.classList.add('active');
        if (criterioOrden === 'puntos') btnSortPuntos.classList.add('active');
        if (criterioOrden === 'precio') btnSortPrecio.classList.add('active');
    }

    // Función Principal: Filtrar y Ordenar el DOM
    function aplicarFiltros() {
        const textoBusqueda = searchInput.value.toLowerCase();

        // 1. Obtener todas las tarjetas en un Array
        let tarjetas = Array.from(container.getElementsByClassName('jugador-card-row'));
        let visibles = 0;

        // 2. Filtrar (Mostrar/Ocultar)
        tarjetas.forEach(card => {
            const esPortero = card.getAttribute('data-es-portero');
            const nombre = card.getAttribute('data-nombre'); // Ya viene en minúsculas del Thymeleaf

            // Lógica StartsWith (empieza por) + Rol
            const coincideRol = (esPortero === rolActual);
            const coincideNombre = nombre.startsWith(textoBusqueda);

            if (coincideRol && coincideNombre) {
                card.classList.remove('d-none-custom');
                visibles++;
            } else {
                card.classList.add('d-none-custom');
            }
        });

        // 3. Ordenar las tarjetas VISIBLES
        // Nota: Aunque ordenamos todas, visualmente solo importan las visibles.
        // Es mejor reordenar el DOM completo para mantener coherencia.

        tarjetas.sort((a, b) => {
            let valorA = 0;
            let valorB = 0;

            if (criterioOrden === 'precio') {
                valorA = parseFloat(a.getAttribute('data-precio'));
                valorB = parseFloat(b.getAttribute('data-precio'));
            } else if (criterioOrden === 'puntos') {
                valorA = parseInt(a.getAttribute('data-puntos'));
                valorB = parseInt(b.getAttribute('data-puntos'));
            } else if (criterioOrden === 'goles') {
                valorA = parseInt(a.getAttribute('data-goles'));
                valorB = parseInt(b.getAttribute('data-goles'));
            }

            // Orden descendente (Mayor a menor)
            return valorB - valorA;
        });

        // 4. Reinsertar en el DOM en el nuevo orden
        tarjetas.forEach(card => container.appendChild(card));

        // 5. Mostrar mensaje si no hay resultados
        if (visibles === 0) {
            noResultsMsg.style.display = 'block';
        } else {
            noResultsMsg.style.display = 'none';
        }
    }

</script>
<script th:replace="~{menu :: menuScripts}"></script>

</body>
</html>